Vagrant.configure("2") do |config|
  (4..6).each do |i|
    config.vm.define "node#{i}" do |node|
      node.vm.box = "alvistack/ubuntu-22.04"
      node.vm.boot_timeout = 488 # Increased timeout to 488 seconds
      node.vm.network "private_network", ip: "192.168.56.#{i}"
      node.vm.network "private_network", ip: "192.168.57.#{i}" # Additional network interface
      node.vm.provider "virtualbox" do |vb|
        vb.gui = true # Enable GUI mode
        vb.cpus = "2"
        vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
        vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
        vb.customize ["modifyvm", :id, "--uart1", "0x3F8", 4]
        if i == 4
          vb.memory = "4096"  # Assign 4GB to node4
        else
          vb.memory = "2048"  # Assign 2GB to others
        end
      end
      # Command to clean and make all files executable
      node.vm.provision 'shell', inline: <<-SHELL
        for file in /vagrant/scripts/*; do
          [ -e "$file" ] || continue
          sed -i 's/\\r//g' "$file"
          sed -i 's/[^[:print:]\\t]//g' "$file"
          chmod +x "$file"
          echo "Cleaned and made executable: $file"
        done
      SHELL
      node.vm.provision 'shell', path: './scripts/01_set.sh', run: 'always'
      node.vm.provision 'shell', inline: 'sudo python3 /vagrant/scripts/02_set.py', run: 'always'
      node.vm.provision 'shell', inline: 'sudo python3 /vagrant/scripts/03_set.py', run: 'always'
      node.vm.provision 'shell', inline: 'sudo python3 /vagrant/scripts/04_set.py', run: 'always'
      node.vm.provision 'shell', inline: 'sudo python3 /vagrant/scripts/05_set.py', run: 'always'
      node.vm.provision 'shell', path: './scripts/07_set.sh', run: 'always'
      node.vm.provision 'shell', path: './scripts/08_set.sh', run: 'always'
      node.vm.provision 'shell', path: './scripts/09_set.sh', run: 'always'
      node.vm.provision 'shell', path: './scripts/compute_add.sh', run: 'always'
      # Log system status before reset
      node.vm.provision 'shell', inline: <<-SHELL
        if [ $(hostname) == "node4" ]; then
          echo "Logging system status before reset..."
          sudo systemctl status sshd
          sudo journalctl -xe
        fi
      SHELL
      # Schedule a reboot after 1 minute using shutdown command for node4
      node.vm.provision 'shell', inline: <<-SHELL
        if [ $(hostname) == "node4" ]; then
          echo "Scheduling reboot in 1 minute..."
          sudo shutdown -r +1
        fi
      SHELL
      # Wait for the scheduled reboot to start for node4
      node.vm.provision 'shell', inline: <<-SHELL
        if [ $(hostname) == "node4" ]; then
          echo "Waiting 70 seconds for the scheduled reboot to start..."
          sleep 70
        fi
      SHELL
    end
  end

  # Trigger to reset node4 from the host
  config.trigger.after :up do |trigger|
    trigger.info = "Resetting node4 using VBoxManage from host..."
    trigger.run = {
      inline: "VBoxManage controlvm node4 reset"
    }
  end

  # Retry SSH connection for node4
  config.trigger.after :provision do |trigger|
    trigger.info = "Attempting to reconnect to node4 via SSH..."
    trigger.run = {
      inline: <<-SCRIPT
        RETRIES=20
        for attempt in $(seq 1 $RETRIES); do
          echo "Attempt $attempt: Trying to SSH into node4..."
          if vagrant ssh node4 -c 'echo SSH connection successful'; then
            echo "SSH connection successful"
            exit 0
          else
            echo "SSH connection failed, retrying in 30 seconds..."
            sleep 30
          fi
        done
        echo "Finished SSH reconnection attempts for node4."
        exit 1
      SCRIPT
    }
  end
end
